import t from"jquery";import e from"@typo3/backend/modal.js";import a from"@typo3/backend/severity.js";import{MessageUtility as n}from"@typo3/backend/utility/message-utility.js";import{G as r}from"./GeneratorButton.js";import{b as i}from"./RemoteCalls.js";function o(){const e=s(document.getElementById("skipExistingDescriptions").checked);t(".t3-alternative-generate-all-total-images").text(e.length);const a=t(e).find(".t3js-ai-tools-credits-view-helper[data-credits]");total=0;for(let e of a){const a=Number(t(e).data("credits"));isNaN(a)||(total+=a)}element=document.getElementById("t3-alternative-generate-all-total-credits"),total?(element.innerHTML=total+" Credits",element.setAttribute("data-credits",total),element.style=""):(element.innerHTML="No Credits",element.setAttribute("data-credits",0),element.style="display: none;")}function s(e){return[...document.querySelectorAll(".imageEntry")].filter((a=>{const n=t(a).data("alternative");return!e||!n}))}function l(t){const e={actionName:"typo3:aiTools:updateField",value:t};n.send(e,function(){if(void 0!==window.parent&&void 0!==window.parent.document.list_frame&&null!==window.parent.document.list_frame.parent.document.querySelector(".t3js-modal-iframe"))return window.parent.document.list_frame;if(void 0!==window.parent&&void 0!==window.parent.frames.list_frame&&null!==window.parent.frames.list_frame.parent.document.querySelector(".t3js-modal-iframe"))return window.parent.frames.list_frame;if(void 0!==window.frames&&void 0!==window.frames.frameElement&&null!==window.frames.frameElement&&window.frames.frameElement.classList.contains("t3js-modal-iframe"))return window.frames.frameElement.contentWindow.parent;if(window.opener)return window.opener}())}t((()=>{t(".textPromptSelect").on("change",(function(){const e=JSON.parse(t(this).val());t(t(this).data("target")).val(e.prompt),t(t(this).data("target")).attr("data-text-prompt-language",e.language)}))})),t((()=>{t(".t3js-alternative-use-current-trigger").on("click",(function(e){e.preventDefault(),e.stopPropagation();const a=t(t(this).data("output-target")),n=t(this).data("current-text"),r=t(this).data("show-target");a.val(n),r&&t(r).show()}))})),t((()=>{t(".t3js-alternative-save-trigger").on("click",(async function(e){e.preventDefault(),e.stopPropagation();const a=t(this).data("file-identifier"),n=t(this).data("target-language"),r=t(this).data("translation-hash"),o=t(t(this).data("output-target")),s=t(t(this).data("button-target")),d=Number(t(this).data("translate")),c=o.val();s.prop("disabled",!0),s.addClass("saving"),t(this).addClass("generating");const g=await i(a,n,c,d).finally((()=>{s.prop("disabled",!1),s.removeClass("saving"),t(this).removeClass("generating")}));if(l(c),t(".t3js-alternative-use-trigger").trigger("click"),console.log("Saving Metadata",g),r)for(const e of g.translations){t("#translate-"+r+"-"+e.languageId).text(e.altTextTranslated)}}))})),t((()=>{const n=new r;t(".t3js-alternative-generate-all").on("click",(async function(r){r.preventDefault(),r.stopPropagation();var i=t(".progressBar").first();const o=Boolean(t(this).data("translate")),l=document.getElementById("skipExistingDescriptions").checked;if(!l){if(!await async function(t){return new Promise((n=>{void 0!==e&&e.confirm?e.confirm("Confirmation Required",t,a.warning,[{text:"Yes",active:!0,btnClass:"btn-warning",name:"yes",trigger:function(){n(!0),e.dismiss()}},{text:"No",name:"no",trigger:function(){n(!1),e.dismiss()}}]):n(confirm(t))}))}("This will overwrite existing descriptions. Are you sure you want to continue?"))return}t(".t3js-alternative-generate-all").prop("disabled",!0),t(".t3js-alternative-generate-all").addClass("generating");const d=s(l);i.attr("max",d.length),i.val(0);for(let e of d){try{const a=t(e).find(".t3js-alternative-generator-trigger").first(),r=t(e).find('.t3js-alternative-save-trigger[data-translate="0"]').first(),i=t(e).find('.t3js-alternative-save-trigger[data-translate="1"]').first();if(await n.triggerGeneratorButton(a),o){if(!i.length)return void console.error("No saveTranslate button found");i.trigger("click")}else{if(!r.length)return void console.error("No save button found");r.trigger("click")}t(e).css("border","1px solid green")}catch(a){console.error("Error while generating metadata",a),t(e).css("border","1px solid red")}i.val(i.val()+1)}t(".t3js-alternative-generate-all").prop("disabled",!1),t(".t3js-alternative-generate-all").removeClass("generating")})),t(".globalTextPrompt").on("change",(function(){t(".textPromptSelect").val(t(this).val()).trigger("change")}))})),t((()=>{document.addEventListener("creditsUpdate",(t=>{o()})),t("#skipExistingDescriptions").on("change",(function(){o()})),o()})),t((()=>{t(".t3js-alternative-use-trigger").on("click",(async function(e){e.preventDefault(),e.stopPropagation();l(t(t(this).data("output-target")).val())}))}));
