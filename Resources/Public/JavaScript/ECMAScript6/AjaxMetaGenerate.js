import t from"jquery";import e from"@typo3/backend/modal.js";import a from"@typo3/backend/severity.js";import{MessageUtility as i}from"@typo3/backend/utility/message-utility.js";import{G as n}from"./GeneratorButton-e413042e.js";import{b as r}from"./RemoteCalls-a7727be1.js";t((()=>{t(".textPromptSelect").on("change",(function(){const e=t(this).val();t(t(this).data("target")).val(e)}))})),t((()=>{t(".textLabelSelect").on("change",(function(){const e=t(this).val();t(t(this).data("target")).val(e),s(e,t(this).data("fileid"))}))}));let o=!0;function s(e,a){-1==e?t("#tag-div-"+a).find(".tag , .default-tag").each((function(){t(this).hide()})):(t("#tag-div-"+a).css("display","block"),t("#tag-div-"+a).find(".tag , .default-tag").each((function(){let a=t(this).data("imagelabelid");0==a||e==a?t(this).css("display","inline-block"):t(this).hide()})))}t((()=>{t(".hide-div").on("click",(function(){o?t("#hide-div-"+t(this).data("file")).css("display","block"):t("#hide-div-"+t(this).data("file")).hide(),o=!o}))})),t((()=>{t(".reset-tag, .global-reset-tag").on("click",(function(){let e=t(this).data("file");s(t("#selectedimageLabel-"+e).val(),e),"123"==e&&t(".reset-tag").trigger("click")}))}));let l=0;function d(){const e=c(document.getElementById("skipExistingDescriptions").checked);t(".t3-alternative-generate-all-total-images").text(e.length);const a=t(e).find(".t3js-ai-tools-credits-view-helper[data-credits]");total=0;for(let e of a){const a=Number(t(e).data("credits"));isNaN(a)||(total+=a)}element=document.getElementById("t3-alternative-generate-all-total-credits"),total?(element.innerHTML=total+" Credits",element.setAttribute("data-credits",total),element.style=""):(element.innerHTML="No Credits",element.setAttribute("data-credits",0),element.style="display: none;")}function c(e){return[...document.querySelectorAll(".imageEntry")].filter((a=>{const i=t(a).data("alternative");return!e||!i}))}function g(t){const e={actionName:"typo3:aiTools:updateField",value:t};i.send(e,function(){if(void 0!==window.parent&&void 0!==window.parent.document.list_frame&&null!==window.parent.document.list_frame.parent.document.querySelector(".t3js-modal-iframe"))return window.parent.document.list_frame;if(void 0!==window.parent&&void 0!==window.parent.frames.list_frame&&null!==window.parent.frames.list_frame.parent.document.querySelector(".t3js-modal-iframe"))return window.parent.frames.list_frame;if(void 0!==window.frames&&void 0!==window.frames.frameElement&&null!==window.frames.frameElement&&window.frames.frameElement.classList.contains("t3js-modal-iframe"))return window.frames.frameElement.contentWindow.parent;if(window.opener)return window.opener}())}t(document).on("click",".add-tag, .global-add-tag",(function(){let e=t(this).data("file"),a=t("#tmp-add-badword-"+e).val();console.log(a+" "+e),a&&(t("#tag-div-"+e).children().eq(1).before(`\n    <span \n      class="tmp-tag" \n      id="tag-tmp-${l}-${e}" \n      data-value="${a}" \n      data-imagelabelid="0" \n      data-file="${e}">\n      ${a}\n      <a href="#" class="remove-tag" data-id="#tag-tmp-${l}-${e}" data-file="${e}">X</a>\n    </span>\n  `),l+=1,"123"==e&&(t(".add-container").each((function(){t(this).val(a)})),t(".add-tag").trigger("click"),t(".add-container").each((function(){t(this).val("")}))),t("#tmp-add-badword-"+e).val(""))})),t(document).on("click",".remove-tag",(function(){let e=!1;t(this).hasClass("tmp-tag")&&(e=!0);let a=t(t(this).data("id")).data("value");"123"==t(this).data("file")&&t(".scroll-container").each((function(){t(this).find(".default-tag, .tag, .tmp-tag").each((function(){t(this).data("value")===a&&(e?t(this).remove():t(this).hide())}))})),e?t(t(this).data("id")).remove():t(t(this).data("id")).hide()})),t((()=>{t(".t3js-alternative-use-current-trigger").on("click",(function(e){e.preventDefault(),e.stopPropagation();const a=t(t(this).data("output-target")),i=t(this).data("current-text"),n=t(this).data("show-target");a.val(i),n&&t(n).show()}))})),t((()=>{t(".t3js-alternative-save-trigger").on("click",(async function(e){e.preventDefault(),e.stopPropagation();const a=t(this).data("file-identifier"),i=t(this).data("target-language"),n=t(this).data("translation-hash"),o=t(t(this).data("output-target")),s=t(t(this).data("button-target")),l=Number(t(this).data("translate")),d=o.val();s.prop("disabled",!0),s.addClass("saving"),t(this).addClass("generating");const c=await r(a,i,d,l).finally((()=>{s.prop("disabled",!1),s.removeClass("saving"),t(this).removeClass("generating")}));if(g(d),t(".t3js-alternative-use-trigger").trigger("click"),console.log("Saving Metadata",c),n)for(const e of c.translations){t("#translate-"+n+"-"+e.languageId).text(e.altTextTranslated)}}))})),t((()=>{const i=new n;t(".t3js-alternative-generate-all").on("click",(async function(n){n.preventDefault(),n.stopPropagation();var r=t(".progressBar").first();const o=Boolean(t(this).data("translate")),s=document.getElementById("skipExistingDescriptions").checked;if(!s){if(!await async function(t){return new Promise((i=>{void 0!==e&&e.confirm?e.confirm("Confirmation Required",t,a.warning,[{text:"Yes",active:!0,btnClass:"btn-warning",name:"yes",trigger:function(){i(!0),e.dismiss()}},{text:"No",name:"no",trigger:function(){i(!1),e.dismiss()}}]):i(confirm(t))}))}("This will overwrite existing descriptions. Are you sure you want to continue?"))return}t(".t3js-alternative-generate-all").prop("disabled",!0),t(".t3js-alternative-generate-all").addClass("generating");const l=c(s);r.attr("max",l.length),r.val(0);for(let e of l){try{const a=t(e).find(".t3js-alternative-generator-trigger").first(),n=t(e).find('.t3js-alternative-save-trigger[data-translate="0"]').first(),r=t(e).find('.t3js-alternative-save-trigger[data-translate="1"]').first();if(await i.triggerGeneratorButton(a),o){if(!r.length)return void console.error("No saveTranslate button found");r.trigger("click")}else{if(!n.length)return void console.error("No save button found");n.trigger("click")}t(e).css("border","1px solid green")}catch(a){console.error("Error while generating metadata",a),t(e).css("border","1px solid red")}r.val(r.val()+1)}t(".t3js-alternative-generate-all").prop("disabled",!1),t(".t3js-alternative-generate-all").removeClass("generating")})),t(".globalTextPrompt").on("change",(function(){t(".textPromptSelect").val(t(this).val()).trigger("change")})),t(".globalTextLabel").on("change",(function(){const e=t(this).val();t(t(this).data("target")).val(e),s(e,t(this).data("fileid")),t(".textLabelSelect").val(t(this).val()).trigger("change")}))})),t((()=>{document.addEventListener("creditsUpdate",(t=>{d()})),t("#skipExistingDescriptions").on("change",(function(){d()})),d()})),t((()=>{t(".t3js-alternative-use-trigger").on("click",(async function(e){e.preventDefault(),e.stopPropagation();g(t(t(this).data("output-target")).val())}))}));
